<html lang="nl">
<head>

    <title>Verrukkuluk</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <link rel="stylesheet" type="text/css" href="assets/bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="assets/css/fonts.css" />
    <link rel="stylesheet" type="text/css" href="assets/css/fontawesome.css" />

    <link rel="stylesheet" type="text/css" href="assets/css/main.css" />

    <script type="text/javascript" language="javascript" src="assets/jquery/jquery-3.5.1.js"></script>
    <script type="text/javascript" language="javascript" src="assets/bootstrap/js/bootstrap.js"></script>

</head>
<body>
<div class="container-fluid">

    <div class="row">
        <div class="col-md-12">
        {% block header %}
        <div class="background-image">
            <img src="assets/img/logo-v2.png" alt="Logo" class="header-logo"/>

            <!-- Search bar -->
            <form class="search-form" action="index.php" method="get" role="search" aria-label="Zoek">
                <input type="hidden" name="action" value="search" />
                <div class="search-pill">
                    <i class="fa fa-search" aria-hidden="true"></i>
                    <input
                        id="q"
                        name="q"
                        type="search"
                        placeholder="Zoek recepten..."
                        value="{{ searchQuery|default('') }}"
                        autocomplete="off"
                        aria-autocomplete="list"
                        aria-controls="searchSuggestions"
                        aria-expanded="false"
                    />
                </div>
                <div id="searchSuggestions" class="search-suggestions" role="listbox" aria-live="polite"></div>
            </form>

            <!-- Hamburger button -->
            <button id="hamburgerBtn" class="hamburger" aria-label="Open menu" aria-expanded="false">
                <span></span>
                <span></span>       
                <span></span>
            </button>

            <!-- Sliding menu (hidden by default) -->
            <nav id="mobileMenu" class="mobile-menu" aria-hidden="true">
                <ul>
                    <li><a href="?action=homepage"><img src="assets/img/logo-v2.png" alt="Logo" class="header-logo"/></a></li>
                    <li><a href="?action=favorites">Mijn Favorieten</a></li>
                    <li><a href="?action=shoppinglist">Mijn Boodschappenlijst</a></li>
                </ul>
            </nav>
        
        </div>
        {% endblock %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-3 sidebar-column">
            <aside class="agenda-bar" aria-label="Agenda">
                <div class="agenda-header">
                    <img src="assets/img/verrukkulluk-agenda.png" alt="Agenda" />
                </div>
                <div class="agenda-content">
                    <ul class="agenda-list">
                        <li class="agenda-item">
                            <div class="agenda-item-date">31</div>
                            <div class="agenda-item-body">
                                <strong>Vegetarisch koken</strong>
                                <p>Een workshop vegetarisch koken, onder leiding van Trientje Hupsakee</p>
                            </div>
                        </li>
                        <li class="agenda-item">
                            <div class="agenda-item-date">31</div>
                            <div class="agenda-item-body">
                                <strong>Vegetarisch koken</strong>
                                <p>Een workshop vegetarisch koken, onder leiding van Trientje Hupsakee</p>
                            </div>
                        </li>
                        <li class="agenda-item">
                            <div class="agenda-item-date">31</div>
                            <div class="agenda-item-body">
                                <strong>Vegetarisch koken</strong>
                                <p>Een workshop vegetarisch koken, onder leiding van Trientje Hupsakee</p>
                            </div>
                        </li>
                        <li class="agenda-item">
                            <div class="agenda-item-date">31</div>
                            <div class="agenda-item-body">
                                <strong>Vegetarisch koken</strong>
                                <p>Een workshop vegetarisch koken, onder leiding van Trientje Hupsakee</p>
                            </div>
                        </li>
                        <li class="agenda-item">
                            <div class="agenda-item-date">31</div>
                            <div class="agenda-item-body">
                                <strong>Vegetarisch koken</strong>
                                <p>Een workshop vegetarisch koken, onder leiding van Trientje Hupsakee</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </aside>

            <div class="login-panel" aria-label="Login formulier">
                <h3>Login</h3>
                <form action="/login" method="post" class="login-form" novalidate>
                    <label for="login-email">Email</label>
                    <input id="login-email" name="email" type="email" placeholder="" required />

                    <label for="login-password">Wachtwoord</label>
                    <input id="login-password" name="password" type="password" placeholder="" required />

                    <button
                        type="button"
                        class="login-btn"
                        onclick="window.location.href='https://youtu.be/xvFZjo5PgG0';"
                    >
                        Login
                    </button>
                </form>
            </div>

        </div>
        <div class="col-md-9">
            {%  block content %}

            {%  endblock %}
        </div>
    </div>


    <div class="row">
        <div class="col-md-12">
            {% block footer %}
            <footer class="site-footer" aria-label="Contact">
                <div class="footer-contact">
                    <img src="assets/img/verrukkulluk-pay-off.png" alt="Logo illustratie" class="footer-contact-image" />
                    <div class="footer-contact-info">
                        <p>
                            <img src="assets/img/verrukkulluk-contact.png" alt="Contact illustratie" class="footer-contact-image" /><br>
                            Verrukkulluk.nl<br />
                            Poststraat 2b<br />
                            Sittard<br />
                            <a href="mailto:info@verrukkulluk.nl">info@verrukkulluk.nl</a>
                        </p>
                    </div>
                </div>
            </footer>
            {% endblock %}
        </div>
    </div>


</div>

</body>
<script>

document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('hamburgerBtn');
    var menu = document.getElementById('mobileMenu');
    if (btn && menu) {
        btn.addEventListener('click', function(){
            var opened = menu.classList.toggle('open');
            btn.setAttribute('aria-expanded', opened ? 'true' : 'false');
            menu.setAttribute('aria-hidden', opened ? 'false' : 'true');
        });
    }

    var searchInput = document.getElementById('q');
    var suggestionsBox = document.getElementById('searchSuggestions');
    var searchForm = document.querySelector('.search-form');
    if (!searchInput || !suggestionsBox || !searchForm) {
        return;
    }

    var activeFetch = null;
    var debounceTimer = null;
    var activeIndex = -1;
    var suggestionIdCounter = 0;

    function getSuggestionItems() {
        return Array.prototype.slice.call(
            suggestionsBox.querySelectorAll('[data-recipe-id]')
        );
    }

    function resetActiveOption() {
        var options = getSuggestionItems();
        options.forEach(function(option) {
            option.classList.remove('is-active');
            option.setAttribute('aria-selected', 'false');
        });
        activeIndex = -1;
        searchInput.removeAttribute('aria-activedescendant');
    }

    function setExpandedState(isExpanded) {
        searchInput.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
        suggestionsBox.setAttribute('aria-hidden', isExpanded ? 'false' : 'true');
        if (isExpanded) {
            suggestionsBox.classList.add('is-visible');
        } else {
            suggestionsBox.classList.remove('is-visible');
        }
    }

    function clearSuggestions() {
        resetActiveOption();
        suggestionsBox.innerHTML = '';
        suggestionsBox.scrollTop = 0;
        setExpandedState(false);
    }

    function setActiveOption(newIndex, options, suppressScroll) {
        var items = options || getSuggestionItems();
        if (!items.length) {
            resetActiveOption();
            return;
        }

        var index = newIndex;
        if (index < 0) {
            index = items.length - 1;
        } else if (index >= items.length) {
            index = 0;
        }

        items.forEach(function(option) {
            option.classList.remove('is-active');
            option.setAttribute('aria-selected', 'false');
        });

        var activeOption = items[index];
        if (!activeOption) {
            resetActiveOption();
            return;
        }

        activeOption.classList.add('is-active');
        activeOption.setAttribute('aria-selected', 'true');
        searchInput.setAttribute('aria-activedescendant', activeOption.id);
        if (!suppressScroll) {
            activeOption.scrollIntoView({ block: 'nearest' });
        }
        activeIndex = index;
    }

    function renderSuggestions(items) {
        suggestionsBox.innerHTML = '';
        suggestionIdCounter = 0;
        if (!items || !items.length) {
            clearSuggestions();
            return;
        }

        var fragment = document.createDocumentFragment();
        items.forEach(function(item) {
            if (!item || typeof item.id === 'undefined' || !item.title) {
                return;
            }

            var link = document.createElement('a');
            suggestionIdCounter += 1;
            link.className = 'search-suggestions__item';
            link.href = '?action=detail&id=' + encodeURIComponent(item.id);
            link.textContent = item.title;
            link.setAttribute('role', 'option');
            link.setAttribute('aria-selected', 'false');
            link.setAttribute('tabindex', '-1');
            link.setAttribute('id', 'searchSuggestion-' + suggestionIdCounter);
            link.setAttribute('data-recipe-id', item.id);
            link.setAttribute('data-title', item.title);
            fragment.appendChild(link);
        });

        if (!fragment.childNodes.length) {
            clearSuggestions();
            return;
        }

        suggestionsBox.appendChild(fragment);
        resetActiveOption();
        setExpandedState(true);
    }

    function fetchSuggestions(term) {
        if (activeFetch) {
            activeFetch.abort();
        }

        var controller = new AbortController();
        activeFetch = controller;
        var params = new URLSearchParams({
            action: 'search_suggestions',
            q: term,
            limit: '8'
        });

        fetch('index.php?' + params.toString(), {
            signal: controller.signal,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Netwerkfout bij ophalen suggesties');
                }
                return response.json();
            })
            .then(function(payload) {
                if (controller !== activeFetch) {
                    return;
                }
                var items = payload && Array.isArray(payload.suggestions) ? payload.suggestions : [];
                renderSuggestions(items);
            })
            .catch(function() {
                if (controller === activeFetch) {
                    clearSuggestions();
                }
            })
            .finally(function() {
                if (controller === activeFetch) {
                    activeFetch = null;
                }
            });
    }

    function scheduleFetch(term) {
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }
        if (term.length < 2) {
            clearSuggestions();
            return;
        }
        debounceTimer = setTimeout(function() {
            fetchSuggestions(term);
        }, 200);
    }

    searchInput.addEventListener('input', function() {
        var term = searchInput.value.trim();
        scheduleFetch(term);
    });

    searchInput.addEventListener('focus', function() {
        var term = searchInput.value.trim();
        if (term.length >= 2 && !suggestionsBox.classList.contains('is-visible')) {
            scheduleFetch(term);
        }
    });

    searchInput.addEventListener('keydown', function(event) {
        var isOpen = suggestionsBox.classList.contains('is-visible');
        var options = getSuggestionItems();

        if (event.key === 'ArrowDown') {
            if (!isOpen) {
                var term = searchInput.value.trim();
                if (term.length >= 2) {
                    event.preventDefault();
                    scheduleFetch(term);
                }
                return;
            }
            if (!options.length) {
                return;
            }
            event.preventDefault();
            var nextIndex = activeIndex < 0 ? 0 : activeIndex + 1;
            setActiveOption(nextIndex, options);
            return;
        }

        if (event.key === 'ArrowUp') {
            if (!isOpen || !options.length) {
                return;
            }
            event.preventDefault();
            var prevIndex = activeIndex < 0 ? options.length - 1 : activeIndex - 1;
            setActiveOption(prevIndex, options);
            return;
        }

        if (event.key === 'Home') {
            if (isOpen && options.length) {
                event.preventDefault();
                setActiveOption(0, options);
            }
            return;
        }

        if (event.key === 'End') {
            if (isOpen && options.length) {
                event.preventDefault();
                setActiveOption(options.length - 1, options);
            }
            return;
        }

        if (event.key === 'Enter') {
            if (isOpen && activeIndex >= 0 && options[activeIndex]) {
                event.preventDefault();
                var selectedOption = options[activeIndex];
                var title = selectedOption.getAttribute('data-title');
                if (title) {
                    searchInput.value = title;
                }
                window.location.href = selectedOption.href;
            }
            return;
        }

        if (event.key === 'Escape') {
            if (isOpen) {
                event.preventDefault();
                clearSuggestions();
            }
        }
    });

    document.addEventListener('click', function(event) {
        if (!searchForm.contains(event.target)) {
            clearSuggestions();
        }
    });

    suggestionsBox.addEventListener('mouseover', function(event) {
        var target = event.target.closest('[data-recipe-id]');
        if (!target) {
            return;
        }
        var options = getSuggestionItems();
        var index = options.indexOf(target);
        if (index !== -1) {
            setActiveOption(index, options, true);
        }
    });

    suggestionsBox.addEventListener('click', function(event) {
        var target = event.target.closest('[data-recipe-id]');
        if (!target) {
            return;
        }

        var title = target.getAttribute('data-title');
        if (title) {
            searchInput.value = title;
        }
    });

    setExpandedState(false);
});
</script>
{% block javascripts %}{% endblock %}
</html>
